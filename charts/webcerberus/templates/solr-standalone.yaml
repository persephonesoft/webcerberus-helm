---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "psnservice.solrServiceName" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ include "psnservice.name" . }}-solr
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: solr
spec:
  type: ClusterIP
  ports:
    - name: http
      port: {{ .Values.solr.service.ports.http }}
      targetPort: solr
      protocol: TCP
  selector:
    app.kubernetes.io/name: {{ include "psnservice.name" . }}-solr
    app.kubernetes.io/instance: {{ .Release.Name }}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "psnservice.fullname" . }}-solr
  namespace: {{ .Release.Namespace | quote }}
  labels:
    app.kubernetes.io/name: {{ include "psnservice.name" . }}-solr
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: solr
spec:
  serviceName: {{ include "psnservice.fullname" . }}-solr
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "psnservice.name" . }}-solr
      app.kubernetes.io/instance: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "psnservice.name" . }}-solr
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: solr
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        fsGroup: 8983
        runAsUser: 8983
        runAsGroup: 8983
      initContainers:
        {{- if and .Values.solr.migration.enabled .Values.solr.migration.bitnamiPvcName }}
        # Migration init container - copies data from Bitnami Solr PVC
        # Handles: main core (persephone), user cores (uXXXXXX), and configsets
        - name: migrate-bitnami-data
          image: "{{ .Values.solr.image.registry }}/{{ .Values.solr.image.repository }}:{{ .Values.solr.image.tag }}"
          imagePullPolicy: {{ .Values.solr.image.pullPolicy | default "IfNotPresent" }}
          command:
            - /bin/bash
            - -c
            - |
              set -e
              # Bitnami Solr stores data at /bitnami-solr/server/solr/ (not /bitnami-solr/data/)
              BITNAMI_SOLR_HOME="/bitnami-solr/server/solr"
              SOLR_DATA="/var/solr/data"
              CORE_NAME="{{ .Values.solr.coreName }}"
              MIGRATION_FLAG=".migrated"
              
              echo "=== Bitnami Solr Full Data Migration ==="
              echo "Source (Bitnami): ${BITNAMI_SOLR_HOME}"
              echo "Target (Community Solr): ${SOLR_DATA}"
              echo "Main core: ${CORE_NAME}"
              echo "Migration flag file: ${MIGRATION_FLAG}"
              
              {{- if .Values.solr.migration.debug }}
              # Debug mode - list contents for troubleshooting
              echo ""
              echo "DEBUG MODE ENABLED"
              echo "To troubleshoot, exec into the container:"
              echo "  kubectl exec -it <pod-name> -c migrate-bitnami-data -n <namespace> -- /bin/bash"
              echo ""
              echo "=== /bitnami-solr structure ==="
              find /bitnami-solr -maxdepth 4 -type d 2>/dev/null || echo "  (not accessible)"
              echo ""
              echo "=== All cores in Bitnami ==="
              ls -la "${BITNAMI_SOLR_HOME}/" 2>/dev/null || echo "  (not accessible)"
              echo ""
              echo "=== Bitnami configsets ==="
              ls -laR "${BITNAMI_SOLR_HOME}/configsets/" 2>/dev/null | head -50 || echo "  (not found)"
              echo ""
              echo "=== Sample core.properties files ==="
              for f in "${BITNAMI_SOLR_HOME}"/u*/core.properties; do
                if [ -f "$f" ]; then
                  echo "--- $f ---"
                  cat "$f"
                  echo ""
                fi
              done 2>/dev/null | head -50
              echo ""
              echo "=== /var/solr/data contents ==="
              ls -laR /var/solr/data/ 2>/dev/null | head -50 || echo "  (not accessible)"
              echo ""
              sleep {{ .Values.solr.migration.debugSleepSeconds | default 3600 }}
              {{- end }}
              
              # Function to check if a directory contains actual Lucene index data
              has_index_data() {
                local dir="$1"
                if [ -d "$dir" ]; then
                  if ls "$dir"/segments_* 1>/dev/null 2>&1 || ls "$dir"/_*.si 1>/dev/null 2>&1; then
                    return 0
                  fi
                fi
                return 1
              }
              
              # Function to get configSet value from core.properties
              get_configset_from_properties() {
                local props_file="$1"
                if [ -f "${props_file}" ]; then
                  grep -E "^configSet=" "${props_file}" 2>/dev/null | cut -d'=' -f2 | tr -d '[:space:]'
                fi
              }
              
              # Function to create migration flag file
              create_migration_flag() {
                local target_dir="$1"
                local core_name="$2"
                echo "migrated=true" > "${target_dir}/${MIGRATION_FLAG}"
                echo "source_core=${core_name}" >> "${target_dir}/${MIGRATION_FLAG}"
                echo "migration_date=$(date -Iseconds)" >> "${target_dir}/${MIGRATION_FLAG}"
                chown 8983:8983 "${target_dir}/${MIGRATION_FLAG}"
              }
              
              # Function to migrate a single core
              # Reads core.properties to determine if it uses a configSet or embedded config
              migrate_core() {
                local src_core_dir="$1"
                local core_name="$2"
                local target_core_dir="${SOLR_DATA}/${core_name}"
                local src_index_dir="${src_core_dir}/data/index"
                local src_props="${src_core_dir}/core.properties"
                
                echo ""
                echo "--- Processing core: ${core_name} ---"
                
                # Check if target already has migration flag - skip if exists
                if [ -f "${target_core_dir}/${MIGRATION_FLAG}" ]; then
                  echo "  Migration flag found - already migrated, skipping"
                  cat "${target_core_dir}/${MIGRATION_FLAG}" | sed 's/^/    /'
                  return 0
                fi
                
                # Check if source has index data
                if [ ! -d "${src_index_dir}" ]; then
                  echo "  No index directory at ${src_index_dir} - skipping"
                  return 0
                fi
                
                if ! has_index_data "${src_index_dir}"; then
                  echo "  No Lucene index data found - skipping"
                  return 0
                fi
                
                echo "  ✓ Source has Lucene index data - proceeding with migration"
                
                # Read source core.properties to determine config mode
                local src_configset=""
                if [ -f "${src_props}" ]; then
                  src_configset=$(get_configset_from_properties "${src_props}")
                  echo "  Source core.properties:"
                  cat "${src_props}" | sed 's/^/    /'
                fi
                
                # Remove any existing target directory (will be recreated)
                if [ -d "${target_core_dir}" ]; then
                  echo "  Removing existing target directory..."
                  rm -rf "${target_core_dir}"
                fi
                
                # Create target directory structure
                mkdir -p "${target_core_dir}/data"
                
                # Copy data directories (index, tlog, snapshot_metadata)
                echo "  Copying data..."
                if [ -d "${src_core_dir}/data/index" ]; then
                  echo "    - index/"
                  cp -r "${src_core_dir}/data/index" "${target_core_dir}/data/"
                fi
                if [ -d "${src_core_dir}/data/tlog" ]; then
                  echo "    - tlog/"
                  cp -r "${src_core_dir}/data/tlog" "${target_core_dir}/data/"
                fi
                if [ -d "${src_core_dir}/data/snapshot_metadata" ]; then
                  echo "    - snapshot_metadata/"
                  cp -r "${src_core_dir}/data/snapshot_metadata" "${target_core_dir}/data/"
                fi
                
                # Determine configuration mode based on source core.properties
                if [ -n "${src_configset}" ]; then
                  # Core uses a configSet - preserve this reference
                  echo "  Config mode: uses configSet '${src_configset}'"
                  cat > "${target_core_dir}/core.properties" << COREPROPS
              name=${core_name}
              configSet=${src_configset}
              dataDir=data
              COREPROPS
                  
                elif [ -d "${src_core_dir}/conf" ]; then
                  # Core has conf/ subdirectory - copy to core's own configset
                  echo "  Config mode: has conf/ directory - creating configset"
                  local configset_dir="${SOLR_DATA}/configsets/${core_name}/conf"
                  mkdir -p "${configset_dir}"
                  cp -r "${src_core_dir}/conf/"* "${configset_dir}/" 2>/dev/null || true
                  
                  # Create configset migration flag
                  create_migration_flag "${SOLR_DATA}/configsets/${core_name}" "${core_name}"
                  chown -R 8983:8983 "${SOLR_DATA}/configsets/${core_name}"
                  chmod -R 775 "${SOLR_DATA}/configsets/${core_name}"
                  
                  cat > "${target_core_dir}/core.properties" << COREPROPS
              name=${core_name}
              configSet=${core_name}
              dataDir=data
              COREPROPS
                  
                elif [ -f "${src_core_dir}/managed-schema" ] || [ -f "${src_core_dir}/solrconfig.xml" ]; then
                  # Core has flat config files in root - copy them directly
                  echo "  Config mode: embedded flat config files"
                  
                  for config_file in managed-schema solrconfig.xml synonyms.txt stopwords.txt protwords.txt stopwords_en.txt; do
                    if [ -f "${src_core_dir}/${config_file}" ]; then
                      echo "    - ${config_file}"
                      cp "${src_core_dir}/${config_file}" "${target_core_dir}/"
                    fi
                  done
                  
                  # Copy lang/ directory if present
                  if [ -d "${src_core_dir}/lang" ]; then
                    echo "    - lang/"
                    cp -r "${src_core_dir}/lang" "${target_core_dir}/"
                  fi
                  
                  # No configSet - uses embedded config
                  cat > "${target_core_dir}/core.properties" << COREPROPS
              name=${core_name}
              dataDir=data
              COREPROPS
                  
                else
                  # No config found - default to main configset
                  echo "  Config mode: no local config - using default configSet '${CORE_NAME}'"
                  cat > "${target_core_dir}/core.properties" << COREPROPS
              name=${core_name}
              configSet=${CORE_NAME}
              dataDir=data
              COREPROPS
                fi
                
                # Clean up core.properties whitespace
                sed -i 's/^[[:space:]]*//' "${target_core_dir}/core.properties"
                
                # Create migration flag for this core
                create_migration_flag "${target_core_dir}" "${core_name}"
                
                # Set permissions
                chown -R 8983:8983 "${target_core_dir}"
                chmod -R 775 "${target_core_dir}"
                
                echo "  ✓ Core ${core_name} migrated successfully"
                echo "  Target core.properties:"
                cat "${target_core_dir}/core.properties" | sed 's/^/    /'
                return 0
              }
              
              # Function to migrate a configset
              migrate_configset() {
                local src_configset_dir="$1"
                local configset_name="$2"
                local target_configset_dir="${SOLR_DATA}/configsets/${configset_name}"
                
                echo ""
                echo "--- Processing configset: ${configset_name} ---"
                
                # Check if target already has migration flag
                if [ -f "${target_configset_dir}/${MIGRATION_FLAG}" ]; then
                  echo "  Migration flag found - already migrated, skipping"
                  cat "${target_configset_dir}/${MIGRATION_FLAG}" | sed 's/^/    /'
                  return 0
                fi
                
                # Check if source has conf/ directory
                if [ ! -d "${src_configset_dir}/conf" ]; then
                  echo "  No conf/ directory - skipping"
                  return 0
                fi
                
                echo "  Copying configset..."
                mkdir -p "${target_configset_dir}"
                cp -r "${src_configset_dir}/"* "${target_configset_dir}/" 2>/dev/null || true
                
                # Create migration flag
                create_migration_flag "${target_configset_dir}" "${configset_name}"
                
                # Set permissions
                chown -R 8983:8983 "${target_configset_dir}"
                chmod -R 775 "${target_configset_dir}"
                
                echo "  ✓ Configset ${configset_name} migrated successfully"
                echo "  Contents:"
                ls -la "${target_configset_dir}/conf/" 2>/dev/null | head -10 | sed 's/^/    /'
                return 0
              }
              
              # Verify Bitnami mount is accessible
              if [ ! -d "${BITNAMI_SOLR_HOME}" ]; then
                echo "ERROR: Bitnami Solr home not found at ${BITNAMI_SOLR_HOME}"
                echo "Contents of /bitnami-solr/:"
                ls -la /bitnami-solr/ 2>/dev/null || echo "  (not accessible)"
                echo "Skipping migration - source not accessible"
                exit 0
              fi
              
              echo ""
              echo "=== Step 1: Migrate configsets ==="
              if [ -d "${BITNAMI_SOLR_HOME}/configsets" ]; then
                echo "Found Bitnami configsets directory"
                mkdir -p "${SOLR_DATA}/configsets"
                
                # Copy all configsets except _default
                for configset_dir in "${BITNAMI_SOLR_HOME}/configsets/"*/; do
                  if [ -d "${configset_dir}" ]; then
                    configset_name=$(basename "${configset_dir}")
                    if [ "${configset_name}" != "_default" ]; then
                      migrate_configset "${configset_dir}" "${configset_name}"
                    fi
                  fi
                done
              else
                echo "No configsets directory found in Bitnami"
              fi
              
              echo ""
              echo "=== Step 2: Migrate main core (${CORE_NAME}) ==="
              if [ -d "${BITNAMI_SOLR_HOME}/${CORE_NAME}" ]; then
                migrate_core "${BITNAMI_SOLR_HOME}/${CORE_NAME}" "${CORE_NAME}"
              else
                echo "Main core ${CORE_NAME} not found as direct core"
                echo "It may be using configset - checking configsets/${CORE_NAME}"
              fi
              
              echo ""
              echo "=== Step 3: Migrate user cores (uXXXXXX pattern) ==="
              USER_CORE_COUNT=0
              SKIPPED_COUNT=0
              for core_dir in "${BITNAMI_SOLR_HOME}"/u[0-9]*/; do
                if [ -d "${core_dir}" ]; then
                  core_name=$(basename "${core_dir}")
                  if [ -f "${core_dir}/core.properties" ]; then
                    if [ -f "${SOLR_DATA}/${core_name}/${MIGRATION_FLAG}" ]; then
                      SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                    else
                      USER_CORE_COUNT=$((USER_CORE_COUNT + 1))
                    fi
                    migrate_core "${core_dir}" "${core_name}"
                  fi
                fi
              done
              echo "User cores: ${USER_CORE_COUNT} migrated, ${SKIPPED_COUNT} skipped (already migrated)"
              
              echo ""
              echo "=== Step 4: Migrate other named cores ==="
              # Migrate any other cores that are not: configsets, _default, userfiles, filestore, or the main core
              for core_dir in "${BITNAMI_SOLR_HOME}"/*/; do
                core_name=$(basename "${core_dir}")
                # Skip known non-core directories and already processed items
                case "${core_name}" in
                  configsets|_default|userfiles|filestore|"${CORE_NAME}"|u[0-9]*)
                    continue
                    ;;
                esac
                if [ -f "${core_dir}/core.properties" ]; then
                  migrate_core "${core_dir}" "${core_name}"
                fi
              done
              
              echo ""
              echo "=== Migration Summary ==="
              echo "Migrated cores (with ${MIGRATION_FLAG} flag):"
              find "${SOLR_DATA}" -maxdepth 2 -name "${MIGRATION_FLAG}" -exec dirname {} \; 2>/dev/null | sort || true
              echo ""
              echo "Cores in target:"
              ls -la "${SOLR_DATA}/" | grep "^d" | grep -v configsets || true
              echo ""
              echo "Configsets available:"
              ls -la "${SOLR_DATA}/configsets/" 2>/dev/null || echo "  (none)"
              echo ""
              echo "=== Migration init container complete ==="
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: solr-data
              mountPath: /var/solr/data
            - name: bitnami-solr-data
              mountPath: /bitnami-solr
              readOnly: true
        {{- end }}
        # Init container to set up custom configset before Solr starts
        # If migration copied Bitnami config, this will skip and just verify permissions
        - name: init-configset
          image: "{{ .Values.solr.image.registry }}/{{ .Values.solr.image.repository }}:{{ .Values.solr.image.tag }}"
          imagePullPolicy: {{ .Values.solr.image.pullPolicy | default "IfNotPresent" }}
          command:
            - /bin/bash
            - -c
            - |
              set -e
              CONFIGSET_DIR="/var/solr/data/configsets/{{ .Values.solr.coreName }}"
              CONF_DIR="${CONFIGSET_DIR}/conf"
              LANG_DIR="${CONF_DIR}/lang"
              
              echo "=== Configset Initialization ==="
              
              # Check if full migration was completed from Bitnami
              if [ -f "/var/solr/data/.migration_complete" ]; then
                echo "Full Bitnami migration was completed"
                cat "/var/solr/data/.migration_complete"
                echo ""
              fi
              
              # Check if configuration was already migrated from Bitnami
              if [ -f "${CONFIGSET_DIR}/.migrated" ]; then
                echo "Configuration was migrated from Bitnami - skipping ConfigMap copy"
                cat "${CONFIGSET_DIR}/.migrated"
                echo ""
                echo "Using migrated configuration:"
                ls -la "${CONF_DIR}/" 2>/dev/null || echo "  (conf dir not found)"
                
                # Just ensure permissions are correct
                echo "Verifying permissions..."
                chown -R 8983:8983 "${CONFIGSET_DIR}"
                chmod -R 775 "${CONFIGSET_DIR}"
                if [ -f "${CONF_DIR}/managed-schema" ]; then
                  chmod 664 "${CONF_DIR}/managed-schema"
                fi
                
                echo "Configset initialization complete (using migrated config)"
                exit 0
              fi
              
              # Check if configset already has a valid schema (from previous run)
              if [ -f "${CONF_DIR}/managed-schema" ] && [ -f "${CONF_DIR}/solrconfig.xml" ]; then
                echo "Configset already exists with schema and config - skipping copy"
                ls -la "${CONF_DIR}/"
                
                # Just ensure permissions are correct
                echo "Verifying permissions..."
                chown -R 8983:8983 "${CONFIGSET_DIR}"
                chmod -R 775 "${CONFIGSET_DIR}"
                chmod 664 "${CONF_DIR}/managed-schema"
                
                echo "Configset initialization complete (using existing config)"
                exit 0
              fi
              
              # No existing config - copy from ConfigMap (fresh install)
              echo "No existing configuration found - copying from ConfigMap"
              echo "Creating custom configset directory: ${CONF_DIR}"
              mkdir -p "${CONF_DIR}"
              mkdir -p "${LANG_DIR}"
              
              echo "Copying configuration files from ConfigMap..."
              # Copy managed-schema (for ManagedIndexSchemaFactory)
              cp /tmp/solr-config/managed-schema "${CONF_DIR}/managed-schema"
              cp /tmp/solr-config/solrconfig.xml "${CONF_DIR}/"
              cp /tmp/solr-config/stopwords.txt "${CONF_DIR}/"
              cp /tmp/solr-config/synonyms.txt "${CONF_DIR}/"
              cp /tmp/solr-config/protwords.txt "${CONF_DIR}/"
              # Copy English stopwords to lang directory (for text_en field type)
              cp /tmp/solr-config/stopwords_en.txt "${LANG_DIR}/stopwords_en.txt"
              
              echo "Setting permissions (writable for schema modifications)..."
              chown -R 8983:8983 "${CONFIGSET_DIR}"
              chmod -R 775 "${CONFIGSET_DIR}"
              chmod 664 "${CONF_DIR}/managed-schema"
              
              echo "Configset initialization complete (fresh install)"
              ls -la "${CONF_DIR}/"
              ls -la "${LANG_DIR}/"
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: solr-data
              mountPath: /var/solr/data
            - name: solr-config
              mountPath: /tmp/solr-config
      containers:
        - name: solr
          image: "{{ .Values.solr.image.registry }}/{{ .Values.solr.image.repository }}:{{ .Values.solr.image.tag }}"
          imagePullPolicy: {{ .Values.solr.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: solr
              containerPort: 8983
              protocol: TCP
          env:
            - name: SOLR_JAVA_MEM
              value: {{ .Values.solr.solrOptions.javaMemory | quote }}
          livenessProbe:
            httpGet:
              path: /solr/admin/info/system
              port: solr
            initialDelaySeconds: 45
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /solr/admin/info/system
              port: solr
            initialDelaySeconds: 15
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          {{- if .Values.solr.podOptions.resources }}
          resources: {{- toYaml .Values.solr.podOptions.resources | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: solr-data
              mountPath: /var/solr/data
            - name: solr-config
              mountPath: /tmp/solr-config
              readOnly: true
            {{- if .Values.solr.migration.debug }}
            - name: bitnami-solr-data
              mountPath: /bitnami-solr
              readOnly: true
            {{- end }}
      volumes:
        - name: solr-config
          configMap:
            name: {{ include "psnservice.fullname" . }}-solr-config
        {{- if and .Values.solr.migration.enabled .Values.solr.migration.bitnamiPvcName }}
        - name: bitnami-solr-data
          persistentVolumeClaim:
            claimName: {{ .Values.solr.migration.bitnamiPvcName }}
        {{- end }}
  volumeClaimTemplates:
    - metadata:
        name: solr-data
      spec:
        accessModes:
          - ReadWriteOnce
        {{- if .Values.solr.dataStorage.persistent.pvc.storageClassName }}
        storageClassName: {{ .Values.solr.dataStorage.persistent.pvc.storageClassName | quote }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.solr.dataStorage.capacity }}
